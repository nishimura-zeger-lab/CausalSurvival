---
title: "Vignette"
author: "Shiyao Xu"
date: "1/19/2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
devtools::load_all("/Users/shiyaoxu/Documents/Research/CausalSurvival")
```

```{r}
hazMethod <- "ns"
```

## Load data

Use synthetic `Eunomia` dataset to illustrate how to perform the simulation study. 

```{r}

connectionDetails <- Eunomia::getEunomiaConnectionDetails()
Eunomia::createCohorts(connectionDetails)

cohortMethodData <- CohortMethod::getDbCohortMethodData(connectionDetails = connectionDetails,
                                                        cdmDatabaseSchema = "main",
                                                        targetId = 1,
                                                        comparatorId = 2,
                                                        outcomeIds = 3,
                                                        exposureDatabaseSchema = "main",
                                                        outcomeDatabaseSchema = "main",
                                                        exposureTable = "cohort",
                                                        outcomeTable = "cohort",
                                                        covariateSettings = FeatureExtraction::createDefaultCovariateSettings())

population <- CohortMethod::createStudyPopulation(cohortMethodData = cohortMethodData,
                                                  outcomeId = 3,
                                                  riskWindowEnd = 99999)

covariateData <- filterAndTidyCovariatesForPs(cohortMethodData, population)
covariates <- covariateData$covariates
row_id <- covariates %>% dplyr::pull(.data$rowId)
covariate_id <- covariates %>% dplyr::pull(.data$covariateId)
val <- covariates %>% dplyr::pull(.data$covariateValue)
covariates <- data.frame(rowId=row_id, covariateId=covariate_id, covariateValue=val)
covariates <- covariates[-which(covariates$covariateId %in% c(1118084410, 1118084412, 1118084413, 1124300410, 1124300412, 1124300413)), ]
covariates$covariateId <- as.numeric(factor(covariates$covariateId))

treatment <- population$treatment
event_time <- population$survivalTime
id <- 1:length(treatment)
rm(list=c("row_id", "covariate_id", "val", "covariateData", "cohortMethodData", "connectionDetails", "population"))
```

Simulate censoring time separately for each treatment group. 

```{r}
censoring_time
outcome
time
```


## Initial parameters

### PS calculation from real data
```{r}
treatProb <- estimateTreatProb(id=id, treatment=treatment, covariates=covariates, covIdTreatProb=NULL)
```

### Survival and censoring hazards from real data
Default is `covId=NULL`, which perform variable selection before estimating survival and censoring hazards. If the researchers have the covariates in mind for simulating hazards, specify in `covId`. 

```{r}
estimatedSurvHazard <- estimateSimulationParams(outcome=outcome, time=time, treatment=treatment, covariates=covariates, 
                                                covId=NULL, hazEstimate="survival", hazMethod=hazMethod, seed=2019)
estimatedCenHazard <- estimateSimulationParams(outcome=outcome, time=time, treatment=treatment, covariates=covariates,
                                               covId=NULL, hazEstimate="censoring", hazMethod=hazMethod, seed=2019)
```

### Counterfactual survival curve and RMST
```{r}
Truth_S <- calculateSurvCurve(coarsenedTime=estimatedSurvHazard$coarsenedData, survHaz=estimatedSurvHazard$haz)
Truth_rmst <- calculateRMST(coarsenedTime=estimatedSurvHazard$coarsenedData, survCurve=Truth_S)
```


## Simulation 

```{r}
SimData <- simData(treatment=treatment, survHaz=estimatedSurvHazard$haz, cenHaz=estimatedCenHazard$haz,
                   coarsenedTime=estimatedSurvHazard$coarsenedData, seed=2019)
```

## Survival and censoring hazards from simulated data

```{r}
## survival hazards and selected covariates
estimatedSurvHazard_sim <- estimateSimulationParams(outcome=outcome, time=time, treatment=treatment, covariates=covariates,
                                                    simOutcome=SimData$ObservedEvent, simTime=SimData$ObservedTime, 
                                                    covId=estimatedSurvHazard$cov_indx,
                                                    hazEstimate="survival", hazMethod=hazMethod)

## censoring hazards and selected covariates
estimatedCenHazard_sim <- estimateSimulationParams(outcome=outcome, time=time, treatment=treatment, covariates=covariates,
                                                   simOutcome=SimData$ObservedEvent, simTime=SimData$ObservedTime, 
                                                   covId=estimatedCenHazard$cov_indx,
                                                   hazEstimate="censoring", hazMethod=hazMethod)
```

## Algorithm

### risk difference
```{r}
tmle_S <- estimateCounterfactSurvival(treatment=treatment, outcome=outcome, time=time,
                                      survHaz=estimatedSurvHazard_sim$haz, cenHaz=estimatedCenHazard_sim$haz, treatProb=treatProb,
                                      coarsenedTime=estimatedSurvHazard$coarsenedData, 
                                      estimand="risk", algorithm="TMLE")

aipw_S <- estimateCounterfactSurvival(treatment=treatment, outcome=outcome, time=time,
                                      survHaz=estimatedSurvHazard_sim$haz, cenHaz=estimatedCenHazard_sim$haz, treatProb=treatProb,
                                      coarsenedTime=estimatedSurvHazard$coarsenedData, 
                                      estimand="risk", algorithm="AIPW")

ipw_S <- estimateCounterfactSurvival(treatment=treatment, outcome=outcome, time=time,
                                      survHaz=estimatedSurvHazard_sim$haz, cenHaz=estimatedCenHazard_sim$haz, treatProb=treatProb,
                                      coarsenedTime=estimatedSurvHazard$coarsenedData, 
                                      estimand="risk", algorithm="IPW")

cox_S <- estimateCounterfactSurvival(treatment=treatment, outcome=outcome, time=time,
                                      survHaz=estimatedSurvHazard_sim$haz, cenHaz=estimatedCenHazard_sim$haz, treatProb=treatProb,
                                      coarsenedTime=estimatedSurvHazard$coarsenedData, 
                                      estimand="risk", algorithm="cox")

weightedCox_S <- estimateCounterfactSurvival(treatment=treatment, outcome=outcome, time=time,
                                      survHaz=estimatedSurvHazard_sim$haz, cenHaz=estimatedCenHazard_sim$haz, treatProb=treatProb,
                                      coarsenedTime=estimatedSurvHazard$coarsenedData, 
                                      estimand="risk", algorithm="weightedCox")

```


### difference in RMST
```{r}
tmle_rmst <- estimateCounterfactSurvival(treatment=treatment, outcome=outcome, time=time,
                                         survHaz=estimatedSurvHazard_sim$haz, 
                                         cenHaz=estimatedCenHazard_sim$haz, treatProb=treatProb,
                                         coarsenedTime=estimatedSurvHazard$coarsenedData, 
                                         estimand="rmst", algorithm="TMLE")

aipw_rmst <- estimateCounterfactSurvival(treatment=treatment, outcome=outcome, time=time,
                                         survHaz=estimatedSurvHazard_sim$haz, 
                                         cenHaz=estimatedCenHazard_sim$haz, treatProb=treatProb,
                                         coarsenedTime=estimatedSurvHazard$coarsenedData, 
                                         estimand="rmst", algorithm="AIPW")

ipw_rmst <- estimateCounterfactSurvival(treatment=treatment, outcome=outcome, time=time,
                                        survHaz=estimatedSurvHazard_sim$haz, 
                                        cenHaz=estimatedCenHazard_sim$haz, treatProb=treatProb,
                                        coarsenedTime=estimatedSurvHazard$coarsenedData, 
                                        estimand="rmst", algorithm="IPW")

cox_rmst <- estimateCounterfactSurvival(treatment=treatment, outcome=outcome, time=time,
                                        survHaz=estimatedSurvHazard_sim$haz, 
                                        cenHaz=estimatedCenHazard_sim$haz, treatProb=treatProb,
                                        coarsenedTime=estimatedSurvHazard$coarsenedData, 
                                        estimand="rmst", algorithm="cox")

weightedCox_rmst <- estimateCounterfactSurvival(treatment=treatment, outcome=outcome, time=time,
                                                survHaz=estimatedSurvHazard_sim$haz, 
                                                cenHaz=estimatedCenHazard_sim$haz, treatProb=treatProb,
                                                coarsenedTime=estimatedSurvHazard$coarsenedData, 
                                                estimand="rmst", algorithm="weightedCox")

```

## Result

















